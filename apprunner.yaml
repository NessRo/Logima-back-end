version: 1.0
runtime: python311

build:
  commands:
    pre-build:
      - python3 --version; pip3 --version
    build:
      - python3 -m pip install -U pip setuptools wheel
      - python3 -m pip install --no-cache-dir -r requirements.txt
    post-build:
      - python3 -c "import fastapi, uvicorn; print('FastAPI', fastapi.__version__); print('Uvicorn', uvicorn.__version__)"

run:
  runtime-version: 3.11
  pre-run:
    - python3 -m pip install --no-cache-dir -r requirements.txt
  command: python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8080
  network:
    port: 8080

  # ---------- NON-SECRETS (plain env) ----------
  env:
    - name: ENV
      value: "prod"
    - name: SQLALCHEMY_ECHO
      value: "false"
    - name: AWS_REGION
      value: "us-east-2"
    - name: FRONTEND_ORIGIN
      value: "https://app.yourdomain.com,http://localhost:5173"
    - name: GOOGLE_REDIRECT_URL
      value: "https://igtj3ec3u2.us-east-2.awsapprunner.com/auth/google/callback"
    - name: S3_BUCKET
      value: "logima"
    - name: S3_KEY_PREFIX
      value: "uploads"
    - name: S3_PRESIGN_EXPIRES
      value: "600"
    - name: S3_MAX_BYTES
      value: "1000000000"
    - name: S3_ALLOWED_CONTENT_TYPES
      value: '["image/png","image/jpeg","application/pdf","text/plain","application/octet-stream"]'
    # --- IAM/RDS Proxy vars (use these instead of DATABASE_URL) ---
    - name: DB_HOST
      value: "logima-backend-app-proxy.proxy-cx2qwwsekqg2.us-east-2.rds.amazonaws.com"
    - name: DB_PORT
      value: "5432"
    - name: DB_NAME
      value: "application_db"
    - name: DB_USER
      value: "app_user"

  # ---------- SECRETS (from Secrets Manager) ----------
  secrets:
    - name: SECRET_KEY
      value-from: "arn:aws:secretsmanager:us-east-2:046481635852:secret:prod/logima/backend-NEe9lb:AWSCURRENT:SECRET_KEY"
    - name: SESSION_SECRET
      value-from: "arn:aws:secretsmanager:us-east-2:046481635852:secret:prod/logima/backend-NEe9lb:AWSCURRENT:SESSION_SECRET"
    - name: OPENAI_API_KEY
      value-from: "arn:aws:secretsmanager:us-east-2:046481635852:secret:prod/logima/backend-NEe9lb:AWSCURRENT:OPENAI_API_KEY"
    - name: GOOGLE_CLIENT_ID
      value-from: "arn:aws:secretsmanager:us-east-2:046481635852:secret:prod/logima/backend-NEe9lb:AWSCURRENT:GOOGLE_CLIENT_ID"
    - name: GOOGLE_CLIENT_SECRET
      value-from: "arn:aws:secretsmanager:us-east-2:046481635852:secret:prod/logima/backend-NEe9lb:AWSCURRENT:GOOGLE_CLIENT_SECRET"
    - name: SQS_UPLOADS_QUEUE_URL
      value-from: "arn:aws:secretsmanager:us-east-2:046481635852:secret:prod/logima/backend-NEe9lb:AWSCURRENT:SQS_UPLOADS_QUEUE_URL"
